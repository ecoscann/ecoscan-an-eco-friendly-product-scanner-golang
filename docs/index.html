<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ecoScanAi</title>
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- 3. Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- 4. html5-qrcode (for barcode scanning) -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <style>
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748; /* gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4ade80; /* green-400 */
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #22c55e; /* green-500 */
        }
    </style>
    <script>
        // Custom Tailwind theme configuration
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'eco-dark': '#1a202c', // gray-900
                        'eco-dark-card': '#2d3748', // gray-800
                        'eco-green': '#4ade80', // green-400
                        'eco-green-dark': '#22c55e', // green-500
                    }
                },
            },
        };
    </script>
</head>
<body class="bg-eco-dark text-white font-sans antialiased">
    <div id="root"></div>

    <!-- This is where all the React code lives -->
    <script type="text/babel">

        const { useState, useEffect, useCallback, StrictMode } = React;

        // --- Configuration ---
        // !!! IMPORTANT: Replace this with your live backend URL
        const API_BASE_URL = "https://ecoscan-an-eco-friendly-product-scanner.onrender.com/api/v1";

        // --- API Helper Functions ---
        
        /**
         * A wrapper for fetch to handle API calls, auth, and errors
         * @param {string} endpoint - The API endpoint (e.g., "/auth/login")
         * @param {object} options - Fetch options (method, headers, body)
         * @param {string|null} token - Optional auth token
         */
        const api = async (endpoint, options = {}, token = null) => {
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers,
            };

            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    ...options,
                    headers,
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: "An unknown error occurred" }));
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }
                
                // Handle responses with no content (e.g., 204 No Content)
                if (response.status === 204) {
                    return null;
                }

                return await response.json();
            } catch (error) {
                console.error("API Error:", error.message);
                throw error; // Re-throw to be caught by the component
            }
        };

        // --- Reusable Components ---

        /**
         * Leaf Icon Component
         */
        const LeafIcon = ({ className }) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fillRule="evenodd" d="M15.402 4.41a.75.75 0 01.79 1.137l-8.01 8.01a.75.75 0 01-1.06 0l-4.5-4.5a.75.75 0 111.06-1.06l3.97 3.97 7.25-7.25a.75.75 0 01.27-.29z" clipRule="evenodd" transform="translate(0, -2)" />
                <path d="M10 18a.75.75 0 01-.75-.75V8.334a.75.75 0 011.5 0v8.916a.75.75 0 01-.75.75z" transform="rotate(45 10 10)" />
                <path d="M10 18a.75.75 0 01-.75-.75V8.334a.75.75 0 011.5 0v8.916a.75.75 0 01-.75.75z" transform="rotate(-45 10 10)" />
            </svg>
        );

        /**
         * Search Icon Component
         */
        const SearchIcon = ({ className }) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
            </svg>
        );
        
        /**
         * Close Icon Component
         */
        const CloseIcon = ({ className }) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
        );

        /**
         * Generic Modal Component
         */
        const Modal = ({ children, onClose, title }) => (
            <div 
                className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75 backdrop-blur-sm"
                onClick={onClose}
            >
                <div 
                    className="bg-eco-dark-card rounded-lg shadow-2xl w-full max-w-md m-4 max-h-[90vh] overflow-y-auto"
                    onClick={e => e.stopPropagation()} // Prevent closing modal on inner click
                >
                    <div className="flex items-center justify-between p-5 border-b border-gray-700">
                        <h3 className="text-xl font-semibold text-eco-green">{title}</h3>
                        <button 
                            onClick={onClose}
                            className="text-gray-400 hover:text-white transition-colors"
                        >
                            <CloseIcon className="w-6 h-6" />
                        </button>
                    </div>
                    <div className="p-6">
                        {children}
                    </div>
                </div>
            </div>
        );
        
        /**
         * Notification Toast Component
         */
        const Notification = ({ message, type = 'error', onDismiss }) => {
            if (!message) return null;

            const bgColor = type === 'error' ? 'bg-red-500' : 'bg-eco-green-dark';
            
            useEffect(() => {
                const timer = setTimeout(onDismiss, 3000);
                return () => clearTimeout(timer);
            }, [message, onDismiss]);

            return (
                <div className={`fixed top-20 right-5 z-50 p-4 rounded-lg shadow-lg text-white ${bgColor}`}>
                    {message}
                    <button onClick={onDismiss} className="ml-4 font-bold">X</button>
                </div>
            );
        };
        
        /**
         * Reusable Product Card
         */
        const ProductCard = ({ product, onClick }) => (
            <div 
                className="bg-eco-dark-card rounded-lg shadow-lg overflow-hidden transition-all duration-300 hover:shadow-eco-green/20 hover:shadow-lg cursor-pointer"
                onClick={() => onClick(product)}
            >
                <img 
                    src={product.image_url || 'https://placehold.co/400x300/2d3748/4ade80?text=No+Image'} 
                    alt={product.name} 
                    className="w-full h-40 object-cover"
                    onError={(e) => e.target.src = 'https://placehold.co/400x300/2d3748/4ade80?text=No+Image'}
                />
                <div className="p-4">
                    <h3 className="text-lg font-semibold text-white truncate">{product.name}</h3>
                    <p className="text-sm text-gray-400 truncate">{product.brand_name}</p>
                    <div className="mt-2 flex items-center justify-between">
                        <span className="text-lg font-bold text-eco-green">Score: {product.score}</span>
                        <span className="text-sm text-gray-300">${product.price.toFixed(2)}</span>
                    </div>
                </div>
            </div>
        );


        // --- Page/View Components ---

        /**
         * Header Component
         */
        const Header = ({ auth, onNavClick, onLogout }) => (
            <header className="sticky top-0 z-40 w-full bg-eco-dark/80 backdrop-blur-lg border-b border-gray-700 shadow-lg">
                <nav className="container mx-auto px-4 sm:px-6 lg:px-8">
                    <div className="flex items-center justify-between h-16">
                        <div 
                            className="flex-shrink-0 flex items-center gap-2 cursor-pointer"
                            onClick={() => onNavClick('home')}
                        >
                            <LeafIcon className="w-8 h-8 text-eco-green" />
                            <span className="text-2xl font-bold text-white">ecoScanAi</span>
                        </div>
                        
                        {/* Desktop Nav */}
                        <div className="hidden sm:flex sm:items-center sm:gap-4">
                            <button onClick={() => onNavClick('home')} className="text-gray-300 hover:text-eco-green px-3 py-2 rounded-md text-sm font-medium transition-colors">Home</button>
                            <button onClick={() => onNavClick('about')} className="text-gray-300 hover:text-eco-green px-3 py-2 rounded-md text-sm font-medium transition-colors">About Us</button>
                            <button onClick={() => onNavClick('scoring')} className="text-gray-300 hover:text-eco-green px-3 py-2 rounded-md text-sm font-medium transition-colors">Scoring</button>
                            
                            <div className="w-px h-6 bg-gray-600 mx-2"></div>
                            
                            {auth ? (
                                <>
                                    <button 
                                        onClick={() => onNavClick('dashboard')} 
                                        className="text-gray-300 hover:text-eco-green px-3 py-2 rounded-md text-sm font-medium transition-colors"
                                    >
                                        Dashboard
                                    </button>
                                    <button 
                                        onClick={onLogout}
                                        className="bg-eco-green-dark text-white px-4 py-2 rounded-full text-sm font-medium hover:bg-eco-green transition-all"
                                    >
                                        Logout
                                    </button>
                                </>
                            ) : (
                                <>
                                    <button 
                                        onClick={() => onNavClick('login')} 
                                        className="text-gray-300 hover:text-eco-green px-3 py-2 rounded-md text-sm font-medium transition-colors"
                                    >
                                        Login
                                    </button>
                                    <button 
                                        onClick={() => onNavClick('register')}
                                        className="bg-eco-green text-eco-dark px-4 py-2 rounded-full text-sm font-medium hover:bg-eco-green-dark hover:text-white transition-all"
                                    >
                                        Create Account
                                    </button>
                                </>
                            )}
                        </div>

                        {/* Mobile Menu Button (placeholder) */}
                        <div className="sm:hidden">
                            {/* You can add a mobile menu dropdown here if needed */}
                            <span className="text-gray-400 text-sm">Menu</span>
                        </div>
                    </div>
                </nav>
            </header>
        );

        /**
         * Barcode Scanner Component
         */
        const BarcodeScanner = ({ onScanSuccess, onScanError }) => {
            const scannerRef = React.useRef(null);

            useEffect(() => {
                // Check if the scanner is already initialized
                if (scannerRef.current) {
                    return;
                }

                // Initialize the scanner
                const html5QrcodeScanner = new Html5QrcodeScanner(
                    "qr-reader", // ID of the div element
                    { 
                        fps: 10, 
                        qrbox: { width: 250, height: 150 },
                        rememberLastUsedCamera: true,
                        supportedScanTypes: [
                            Html5QrcodeScanType.SCAN_TYPE_CAMERA,
                        ]
                    },
                    false // verbose
                );

                const scanSuccess = (decodedText, decodedResult) => {
                    // Stop the scanner
                    html5QrcodeScanner.clear().catch(err => console.error("Failed to clear scanner", err));
                    onScanSuccess(decodedText);
                };

                const scanError = (errorMessage) => {
                    // handle scan error, but we can ignore most common ones
                    // onScanError(errorMessage);
                };

                // Start scanning
                html5QrcodeScanner.render(scanSuccess, scanError);
                
                // Store scanner instance to clear it on unmount
                scannerRef.current = html5QrcodeScanner;

                // Cleanup function
                return () => {
                    if (scannerRef.current) {
                        scannerRef.current.clear().catch(err => {
                            console.error("Failed to clear html5QrcodeScanner on unmount", err);
                        });
                        scannerRef.current = null;
                    }
                };
            }, [onScanSuccess, onScanError]);

            return (
                <div className="w-full max-w-lg mx-auto bg-eco-dark-card rounded-lg shadow-xl overflow-hidden">
                    <div id="qr-reader" className="w-full"></div>
                    <p className="text-center text-gray-400 p-4">Align barcode within the frame</p>
                </div>
            );
        };
        
        /**
         * Home Page Component
         */
        const HomePage = ({ onScanSuccess, onSearch }) => {
            const [query, setQuery] = useState("");

            const handleSubmit = (e) => {
                e.preventDefault();
                if (query.trim()) {
                    onSearch(query.trim());
                }
            };
            
            return (
                <div className="container mx-auto px-4 py-8 flex flex-col items-center gap-12">
                    {/* 1. Search Bar */}
                    <form onSubmit={handleSubmit} className="w-full max-w-2xl relative">
                        <input
                            type="search"
                            value={query}
                            onChange={(e) => setQuery(e.target.value)}
                            placeholder="Search product by name..."
                            className="w-full py-4 pl-12 pr-6 bg-eco-dark-card border border-gray-700 rounded-full text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-eco-green"
                        />
                        <div className="absolute left-4 top-1/2 -translate-y-1/2">
                            <SearchIcon className="w-6 h-6 text-gray-400" />
                        </div>
                    </form>

                    {/* 2. Barcode Scanner */}
                    <div className="w-full flex flex-col items-center gap-4">
                        <h2 className="text-2xl font-semibold text-white">Scan Barcode</h2>
                        <p className="text-gray-400 max-w-md text-center">
                            Use your camera to scan a product's barcode and get its eco-score instantly.
                        </p>
                        <BarcodeScanner 
                            onScanSuccess={onScanSuccess}
                            onScanError={(err) => console.warn("Scan Error:", err)}
                        />
                    </div>
                </div>
            );
        };
        
        /**
         * Product Modal Component (for search/scan results)
         */
        const ProductModal = ({ barcode, onGoBack, auth, onProductRequest }) => {
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [productData, setProductData] = useState(null); // { product: {}, alternatives: [] }

            useEffect(() => {
                if (!barcode) return;
                
                setLoading(true);
                setError(null);
                setProductData(null);
                
                api(`/products/barcode/${barcode}`)
                    .then(data => {
                        setProductData(data);
                    })
                    .catch(err => {
                        console.error(err);
                        if (err.message.includes("not found")) {
                            setError("Product not found in our database.");
                        } else {
                            setError("Failed to fetch product data.");
                        }
                    })
                    .finally(() => {
                        setLoading(false);
                    });
                
            }, [barcode]);
            
            // This component handles the 'Product Not Found' case
            if (error === "Product not found in our database.") {
                return (
                    <Modal title="Product Not Found" onClose={onGoBack}>
                        <div className="text-center">
                            <p className="text-gray-300 mb-4">
                                We couldn't find the barcode "{barcode}" in our database.
                            </p>
                            {auth ? (
                                <button
                                    onClick={() => onProductRequest(barcode)}
                                    className="w-full bg-eco-green text-eco-dark font-bold py-3 px-4 rounded-lg transition-all hover:bg-eco-green-dark hover:text-white"
                                >
                                    Help Us by Requesting This Product
                                </button>
                            ) : (
                                <p className="text-gray-400 p-3 bg-gray-700 rounded-lg">
                                    Please <a href="#" onClick={(e) => { e.preventDefault(); /* todo: trigger login */ }} className="text-eco-green underline">login</a> to request this product and earn points!
                                </p>
                            )}
                        </div>
                    </Modal>
                );
            }
            
            if (loading) {
                return (
                    <Modal title="Loading Product..." onClose={onGoBack}>
                        <div className="flex justify-center items-center h-40">
                           <LeafIcon className="w-12 h-12 text-eco-green animate-spin" />
                        </div>
                    </Modal>
                );
            }
            
            if (error) {
                return (
                    <Modal title="Error" onClose={onGoBack}>
                        <p className="text-red-400 text-center">{error}</p>
                    </Modal>
                );
            }
            
            if (!productData || !productData.product) {
                return null;
            }
            
            const { product, alternatives } = productData;

            return (
                <Modal title="Product Details" onClose={onGoBack}>
                    <div className="space-y-6">
                        {/* Main Product */}
                        <div className="flex flex-col sm:flex-row gap-4">
                            <img
                                src={product.image_url || 'https://placehold.co/400x400/2d3748/4ade80?text=No+Image'}
                                alt={product.name}
                                className="w-full sm:w-1/3 h-auto object-cover rounded-lg"
                                onError={(e) => e.target.src = 'https://placehold.co/400x400/2d3748/4ade80?text=No+Image'}
                            />
                            <div className="flex-1">
                                <h2 className="text-2xl font-bold text-white">{product.name}</h2>
                                <p className="text-lg text-gray-400">{product.brand_name}</p>
                                <p className="text-xl font-bold text-gray-200 mt-2">${product.price.toFixed(2)}</p>
                                
                                <div className="mt-4 p-4 bg-gray-700 rounded-lg">
                                    <h4 className="text-lg font-semibold text-eco-green">Eco Score: {product.score} / 100</h4>
                                    <p className="text-sm text-gray-300">
                                        Based on packaging, manufacturing, and disposal.
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        {/* Score Breakdown */}
                        <div className="space-y-2">
                             <h4 className="text-lg font-semibold text-gray-200">Score Details:</h4>
                             <div className="flex justify-between text-gray-300">
                                <span>Packaging Material:</span>
                                <span className="font-medium text-white capitalize">{product.packaging_material.replace(/_/g, ' ')}</span>
                             </div>
                             <div className="flex justify-between text-gray-300">
                                <span>Manufacturing Location:</span>
                                <span className="font-medium text-white capitalize">{product.manufacturing_location}</span>
                             </div>
                             <div className="flex justify-between text-gray-300">
                                <span>Disposal Method:</span>
                                <span className="font-medium text-white capitalize">{product.disposal_method.replace(/_/g, ' ')}</span>
                             </div>
                        </div>

                        {/* Alternatives */}
                        {alternatives && alternatives.length > 0 && (
                            <div className="space-y-3">
                                <h3 className="text-xl font-semibold text-eco-green">Greener Alternatives</h3>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    {alternatives.map(alt => (
                                        <ProductCard key={alt.id} product={alt} onClick={() => alert(`Clicked on ${alt.name}`)} />
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </Modal>
            );
        };
        
        /**
         * Search Results Modal
         */
        const SearchResultsModal = ({ query, onGoBack, onProductSelect }) => {
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [results, setResults] = useState([]);

            useEffect(() => {
                if (!query) return;

                setLoading(true);
                setError(null);
                setResults([]);

                api(`/products/search?q=${encodeURIComponent(query)}`)
                    .then(data => {
                        setResults(data || []); // Ensure data is an array
                    })
                    .catch(err => {
                        console.error(err);
                        setError("Search failed. Please try again.");
                    })
                    .finally(() => {
                        setLoading(false);
                    });

            }, [query]);

            return (
                <Modal title={`Search Results for "${query}"`} onClose={onGoBack}>
                    <div className="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                        {loading && (
                            <div className="flex justify-center items-center h-40">
                                <LeafIcon className="w-12 h-12 text-eco-green animate-spin" />
                            </div>
                        )}
                        {error && <p className="text-red-400 text-center">{error}</p>}
                        {!loading && !error && results.length === 0 && (
                            <p className="text-gray-400 text-center">No products found matching your search.</p>
                        )}
                        {!loading && !error && results.length > 0 && (
                            <div className="grid grid-cols-1 gap-4">
                                {results.map(product => (
                                    <div 
                                        key={product.id}
                                        className="flex items-center gap-4 bg-eco-dark-card p-3 rounded-lg cursor-pointer hover:bg-gray-700"
                                        onClick={() => onProductSelect(product.barcode)}
                                    >
                                        <img 
                                            src={product.image_url || 'https://placehold.co/100x100/2d3748/4ade80?text=...'}
                                            alt={product.name}
                                            className="w-16 h-16 object-cover rounded-md flex-shrink-0"
                                            onError={(e) => e.target.src = 'https://placehold.co/100x100/2d3748/4ade80?text=...'}
                                        />
                                        <div className="flex-1 overflow-hidden">
                                            <h4 className="text-base font-semibold text-white truncate">{product.name}</h4>
                                            <p className="text-sm text-gray-400 truncate">{product.brand_name}</p>
                                        </div>
                                        <span className="text-base font-bold text-eco-green">Score: {product.score}</span>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </Modal>
            );
        };
        
        /**
         * Product Request Modal
         */
        const ProductRequestModal = ({ barcode, auth, onGoBack, onNotify }) => {
            const [formData, setFormData] = useState({
                barcode: barcode || '',
                name: '',
                brandname: '', // Matches backend 'brandname'
                productImage: null,
            });
            const [loading, setLoading] = useState(false);
            
            const handleChange = (e) => {
                const { name, value, files } = e.target;
                setFormData(prev => ({
                    ...prev,
                    [name]: files ? files[0] : value
                }));
            };
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!formData.name || !formData.barcode || !formData.productImage) {
                    onNotify("Please fill in all fields and upload an image.", "error");
                    return;
                }
                
                setLoading(true);
                
                // We need to use FormData for file uploads
                const data = new FormData();
                data.append('barcode', formData.barcode);
                data.append('name', formData.name);
                data.append('brandname', formData.brandname);
                data.append('productImage', formData.productImage);

                try {
                    // We can't use the JSON 'api' helper for FormData
                    const response = await fetch(`${API_BASE_URL}/products/request`, {
                        method: 'POST',
                        headers: {
                            // Don't set Content-Type, browser does it for FormData
                            'Authorization': `Bearer ${auth.token}`,
                        },
                        body: data,
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ message: "An unknown error occurred" }));
                        throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    onNotify("Product requested successfully! You earned 10 points.", "success");
                    onGoBack(); // Close the modal
                    // TODO: Could also update auth state with new points
                    
                } catch (error) {
                    console.error("Product Request Error:", error);
                    onNotify(error.message, "error");
                } finally {
                    setLoading(false);
                }
            };
            
            return (
                <Modal title="Request New Product" onClose={onGoBack}>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label htmlFor="barcode" className="block text-sm font-medium text-gray-300">Barcode</label>
                            <input
                                type="text"
                                name="barcode"
                                id="barcode"
                                value={formData.barcode}
                                onChange={handleChange}
                                required
                                className="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-eco-green focus:border-eco-green"
                            />
                        </div>
                        <div>
                            <label htmlFor="name" className="block text-sm font-medium text-gray-300">Product Name</label>
                            <input
                                type="text"
                                name="name"
                                id="name"
                                value={formData.name}
                                onChange={handleChange}
                                required
                                className="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-eco-green focus:border-eco-green"
                            />
                        </div>
                        <div>
                            <label htmlFor="brandname" className="block text-sm font-medium text-gray-300">Brand Name (Optional)</label>
                            <input
                                type="text"
                                name="brandname"
                                id="brandname"
                                value={formData.brandname}
                                onChange={handleChange}
                                className="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-eco-green focus:border-eco-green"
                            />
                        </div>
                        <div>
                            <label htmlFor="productImage" className="block text-sm font-medium text-gray-300">Product Image</label>
                            <input
                                type="file"
                                name="productImage"
                                id="productImage"
                                accept="image/*"
                                onChange={handleChange}
                                required
                                className="mt-1 block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-eco-green file:text-eco-dark hover:file:bg-eco-green-dark hover:file:text-white"
                            />
                        </div>
                        <button
                            type="submit"
                            disabled={loading}
                            className="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-eco-dark bg-eco-green hover:bg-eco-green-dark hover:text-white disabled:opacity-50 disabled:cursor-not-allowed transition-all"
                        >
                            {loading ? <LeafIcon className="w-5 h-5 animate-spin" /> : 'Submit Request'}
                        </button>
                    </form>
                </Modal>
            );
        };
        
        /**
         * Auth Form Component (Login/Register)
         */
        const AuthForm = ({ mode, onAuthSuccess, onNotify }) => {
            const [formData, setFormData] = useState({ name: '', email: '', password: '' });
            const [loading, setLoading] = useState(false);
            const isLogin = mode === 'login';
            
            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                onNotify(null); // Clear previous errors

                const endpoint = isLogin ? '/auth/login' : '/auth/register';
                const body = isLogin 
                    ? JSON.stringify({ email: formData.email, password: formData.password })
                    : JSON.stringify({ name: formData.name, email: formData.email, password: formData.password });
                
                try {
                    const data = await api(endpoint, { method: 'POST', body });
                    onAuthSuccess(data); // data is LoginResponse or repo.User
                } catch (error) {
                    onNotify(error.message, 'error');
                } finally {
                    setLoading(false);
                }
            };
            
            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    {!isLogin && (
                        <div>
                            <label htmlFor="name" className="block text-sm font-medium text-gray-300">Name</label>
                            <input
                                type="text"
                                name="name"
                                id="name"
                                value={formData.name}
                                onChange={handleChange}
                                required
                                className="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-eco-green focus:border-eco-green"
                            />
                        </div>
                    )}
                    <div>
                        <label htmlFor="email" className="block text-sm font-medium text-gray-300">Email address</label>
                        <input
                            type="email"
                            name="email"
                            id="email"
                            value={formData.email}
                            onChange={handleChange}
                            required
                            autoComplete="email"
                            className="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-eco-green focus:border-eco-green"
                        />
                    </div>
                    <div>
                        <label htmlFor="password" className="block text-sm font-medium text-gray-300">Password</label>
                        <input
                            type="password"
                            name="password"
                            id="password"
                            value={formData.password}
                            onChange={handleChange}
                            required
                            autoComplete={isLogin ? "current-password" : "new-password"}
                            className="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-eco-green focus:border-eco-green"
                        />
                        {!isLogin && <p className="mt-1 text-xs text-gray-400">Must be at least 8 characters long.</p>}
                    </div>
                    
                    <button
                        type="submit"
                        disabled={loading}
                        className="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-eco-dark bg-eco-green hover:bg-eco-green-dark hover:text-white disabled:opacity-50 disabled:cursor-not-allowed transition-all"
                    >
                        {loading ? (
                            <LeafIcon className="w-5 h-5 animate-spin" />
                        ) : (
                            isLogin ? 'Sign In' : 'Create Account'
                        )}
                    </button>
                </form>
            );
        };

        /**
         * Dashboard Page Component
         */
        const DashboardPage = ({ auth }) => {
            if (!auth) return null; // Should be protected by router
            
            const { user } = auth;
            
            return (
                <div className="container mx-auto px-4 py-8">
                    <h1 className="text-4xl font-bold text-white mb-2">
                        Welcome back, <span className="text-eco-green">{user.name}</span>!
                    </h1>
                    <p className="text-lg text-gray-400 mb-8">Here's your eco-dashboard.</p>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {/* Profile Info */}
                        <div className="bg-eco-dark-card p-6 rounded-lg shadow-lg">
                            <h2 className="text-2xl font-semibold text-eco-green mb-4">Profile Info</h2>
                            <div className="space-y-3">
                                <div className="flex justify-between">
                                    <span className="text-gray-400">Name:</span>
                                    <span className="text-white font-medium">{user.name}</span>
                                </div>
                                <div className="flex justify-between">
                                    <span className="text-gray-400">Email:</span>
                                    <span className="text-white font-medium">{user.email}</span>
                                </div>
                                <div className="flex justify-between">
                                    <span className="text-gray-400">Member Since:</span>
                                    <span className="text-white font-medium">{new Date(user.created_at).toLocaleDateString()}</span>
                                </div>
                            </div>
                        </div>
                        
                        {/* Score/Points */}
                        <div className="bg-eco-dark-card p-6 rounded-lg shadow-lg flex flex-col items-center justify-center text-center">
                            <h2 className="text-2xl font-semibold text-eco-green mb-2">Your Eco-Points</h2>
                            <p className="text-6xl font-bold text-white">{user.points}</p>
                            <p className="text-gray-400 mt-2">
                                Keep scanning and requesting products to earn more!
                            </p>
                        </div>
                    </div>
                </div>
            );
        };
        
        /**
         * About Us Page Component
         */
        const AboutPage = () => (
            <div className="container mx-auto px-4 py-8">
                <div className="max-w-3xl mx-auto bg-eco-dark-card p-8 rounded-lg shadow-lg">
                    <h1 className="text-4xl font-bold text-center text-eco-green mb-6">About ecoScanAi</h1>
                    <p className="text-lg text-gray-300 mb-6 leading-relaxed">
                        ecoScanAi was born from a shared passion for sustainability and technology. Our mission is to empower consumers to make environmentally conscious decisions with a simple scan of a barcode. We believe that by providing transparent, easy-to-understand data on product sustainability, we can collectively drive change and promote a greener future.
                    </p>
                    
                    <h2 className="text-3xl font-semibold text-white text-center mb-8">Meet the Team</h2>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="bg-gray-700 p-5 rounded-lg text-center">
                            <h3 className="text-xl font-bold text-white">Razibul Hasan Badhon</h3>
                            <p className="text-eco-green font-medium">Backend & Project Management</p>
                        </div>
                        <div className="bg-gray-700 p-5 rounded-lg text-center">
                            <h3 className="text-xl font-bold text-white">Abdullah Alif</h3>
                            <p className="text-eco-green font-medium">Backend Developer</p>
                        </div>
                        <div className="bg-gray-700 p-5 rounded-lg text-center">
                            <h3 className="text-xl font-bold text-white">Rifat Hassan</h3>
                            <p className="text-eco-green font-medium">Frontend Developer</p>
                        </div>
                        <div className="bg-gray-700 p-5 rounded-lg text-center">
                            <h3 className="text-xl font-bold text-white">Lubna Jahan Lipa</h3>
                            <p className="text-eco-green font-medium">Database Management</p>
                        </div>
                    </div>
                </div>
            </div>
        );
        
        /**
         * Scoring Algorithm Page Component
         */
        const ScoringPage = () => {
            const scoreDetails = [
                {
                    title: "Packaging (35% Weight)",
                    categories: [
                        { name: "None, Compostable Paper", score: 100 },
                        { name: "Glass, Paper, Cardboard", score: 80 },
                        { name: "Aluminum, Recyclable Plastic", score: 60 },
                        { name: "Unknown / Other", score: 40 },
                        { name: "Plastic, Mixed Materials", score: 20 },
                    ]
                },
                {
                    title: "Transportation (30% Weight)",
                    categories: [
                        { name: "Local, Regional", score: 95 },
                        { name: "National", score: 70 },
                        { name: "Unknown / Other", score: 50 },
                        { name: "International", score: 30 },
                    ]
                },
                {
                    title: "Disposal (35% Weight)",
                    categories: [
                        { name: "Compostable, Reusable", score: 100 },
                        { name: "Recyclable", score: 85 },
                        { name: "Minimal Impact", score: 70 },
                        { name: "Unknown / Other", score: 40 },
                        { name: "Landfill", score: 10 },
                    ]
                }
            ];
            
            return (
                <div className="container mx-auto px-4 py-8">
                    <div className="max-w-3xl mx-auto bg-eco-dark-card p-8 rounded-lg shadow-lg">
                        <h1 className="text-4xl font-bold text-center text-eco-green mb-6">Our Scoring Algorithm</h1>
                        <p className="text-lg text-gray-300 mb-6 leading-relaxed">
                            To ensure transparency and help you understand our product ratings, we've outlined our scoring algorithm below. The final "Eco-Score" (out of 100) is a weighted average of three key factors: Packaging, Transportation, and Disposal.
                        </p>
                        
                        <div className="text-center bg-gray-700 p-4 rounded-lg mb-8">
                            <p className="text-xl font-bold text-white">
                                Final Score = (Packaging * 0.35) + (Transportation * 0.30) + (Disposal * 0.35)
                            </p>
                        </div>
                        
                        <div className="space-y-8">
                            {scoreDetails.map((section, idx) => (
                                <div key={idx}>
                                    <h2 className="text-2xl font-semibold text-white mb-3">{section.title}</h2>
                                    <ul className="divide-y divide-gray-700">
                                        {section.categories.map((cat, catIdx) => (
                                            <li key={catIdx} className="flex justify-between items-center py-3">
                                                <span className="text-gray-300">{cat.name}</span>
                                                <span className="font-bold text-lg text-eco-green">{cat.score} pts</span>
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                            ))}
                        </div>
                        
                        <p className="text-sm text-gray-400 mt-8 text-center">
                            Disclaimer: This scoring model is based on our internal logic and publicly available data. It is intended for informational purposes to guide consumers and may not capture every nuance of a product's lifecycle.
                        </p>
                    </div>
                </div>
            );
        };
        
        /**
         * Footer Component
         */
        const Footer = () => (
            <footer className="bg-eco-dark border-t border-gray-700 mt-16">
                <div className="container mx-auto px-4 py-6 text-center text-gray-400">
                    <p>&copy; {new Date().getFullYear()} ecoScanAi. All rights reserved.</p>
                </div>
            </footer>
        );

        // --- Main App Component ---

        function App() {
            // --- State ---
            const [page, setPage] = useState('home'); // 'home', 'about', 'scoring', 'dashboard'
            const [modal, setModal] = useState(null); // 'login', 'register', 'product', 'search', 'request'
            const [modalData, setModalData] = useState(null); // Stores barcode, query, etc. for the modal
            const [auth, setAuth] = useState(null); // { token: '...', user: {...} }
            const [notification, setNotification] = useState({ message: null, type: 'error' });
            
            // --- Auth Effect ---
            // Load auth data from localStorage on initial render
            useEffect(() => {
                const storedAuth = localStorage.getItem('ecoScanAuth');
                if (storedAuth) {
                    setAuth(JSON.parse(storedAuth));
                }
            }, []);

            // --- Handlers ---
            
            const handleNotify = (message, type = 'error') => {
                setNotification({ message, type });
            };
            
            const handleAuthSuccess = (data) => {
                let authData;
                if (data.access_token) { // Login response
                    authData = { token: data.access_token, user: data.user };
                    handleNotify("Login successful!", "success");
                } else { // Register response (returns user only)
                    // We need to auto-login the user after register, but the API doesn't return a token
                    // For now, just notify and ask them to log in.
                    // A better backend would return a token on register or I'd have to make a login call.
                    // For this demo, I'll just show a success message.
                    handleNotify("Registration successful! Please log in.", "success");
                    setModal('login');
                    return;
                }
                
                setAuth(authData);
                localStorage.setItem('ecoScanAuth', JSON.stringify(authData));
                setModal(null); // Close auth modal
                setPage('dashboard'); // Redirect to dashboard
            };
            
            const handleLogout = () => {
                setAuth(null);
                localStorage.removeItem('ecoScanAuth');
                setPage('home');
                handleNotify("Logged out successfully.", "success");
            };
            
            const handleNavClick = (targetPage) => {
                // Handle auth modal triggers
                if (targetPage === 'login' || targetPage === 'register') {
                    setModal(targetPage);
                    setModalData(null);
                } else {
                    // Handle page navigation
                    setPage(targetPage);
                    setModal(null); // Close any open modals
                    setModalData(null);
                }
            };
            
            const handleScanSuccess = (barcode) => {
                console.log("Scanned Barcode:", barcode);
                setModal('product');
                setModalData({ barcode });
            };
            
            const handleSearch = (query) => {
                console.log("Search Query:", query);
                setModal('search');
                setModalData({ query });
            };
            
            const handleProductSelect = (barcode) => {
                // From search results, open product modal
                setModal('product');
                setModalData({ barcode });
            };
            
            const handleProductRequest = (barcode) => {
                setModal('request');
                setModalData({ barcode });
            };
            
            const closeModal = () => {
                setModal(null);
                setModalData(null);
                // After closing scanner-related modals, we need to re-render homepage
                // to re-initialize the scanner. A bit of a hack.
                if (page === 'home' && (modal === 'product' || modal === 'search' || modal === 'request')) {
                    setPage(''); // Force re-mount
                    setTimeout(() => setPage('home'), 0);
                }
            };

            // --- Render Logic ---
            
            const renderPage = () => {
                switch(page) {
                    case 'home':
                        return <HomePage onScanSuccess={handleScanSuccess} onSearch={handleSearch} />;
                    case 'about':
                        return <AboutPage />;
                    case 'scoring':
                        return <ScoringPage />;
                    case 'dashboard':
                        return auth ? <DashboardPage auth={auth} /> : <HomePage onScanSuccess={handleScanSuccess} onSearch={handleSearch} />;
                    default:
                        return <HomePage onScanSuccess={handleScanSuccess} onSearch={handleSearch} />;
                }
            };
            
            const renderModal = () => {
                switch(modal) {
                    case 'login':
                        return (
                            <Modal title="Login to ecoScanAi" onClose={closeModal}>
                                <AuthForm 
                                    mode="login" 
                                    onAuthSuccess={handleAuthSuccess}
                                    onNotify={handleNotify} 
                                />
                                <p className="text-center text-sm text-gray-400 mt-4">
                                    Don't have an account?{' '}
                                    <button 
                                        onClick={() => setModal('register')} 
                                        className="font-medium text-eco-green hover:underline"
                                    >
                                        Sign up
                                    </button>
                                </p>
                            </Modal>
                        );
                    case 'register':
                         return (
                            <Modal title="Create Your Account" onClose={closeModal}>
                                <AuthForm 
                                    mode="register" 
                                    onAuthSuccess={handleAuthSuccess}
                                    onNotify={handleNotify} 
                                />
                                <p className="text-center text-sm text-gray-400 mt-4">
                                    Already have an account?{' '}
                                    <button 
                                        onClick={() => setModal('login')} 
                                        className="font-medium text-eco-green hover:underline"
                                    >
                                        Sign in
                                    </button>
                                </p>
                            </Modal>
                        );
                    case 'product':
                        return (
                            <ProductModal 
                                barcode={modalData?.barcode}
                                onGoBack={closeModal}
                                auth={auth}
                                onProductRequest={handleProductRequest}
                            />
                        );
                    case 'search':
                        return (
                            <SearchResultsModal 
                                query={modalData?.query}
                                onGoBack={closeModal}
                                onProductSelect={handleProductSelect}
                            />
                        );
                    case 'request':
                        return (
                            <ProductRequestModal
                                barcode={modalData?.barcode}
                                auth={auth}
                                onGoBack={closeModal}
                                onNotify={handleNotify}
                            />
                        );
                    default:
                        return null;
                }
            };
            
            return (
                <div className="min-h-screen flex flex-col">
                    <Notification 
                        message={notification.message}
                        type={notification.type}
                        onDismiss={() => setNotification({ message: null, type: 'error' })}
                    />
                    <Header 
                        auth={auth}
                        onNavClick={handleNavClick}
                        onLogout={handleLogout}
                    />
                    <main className="flex-grow">
                        {renderPage()}
                        {renderModal()}
                    </main>
                    <Footer />
                </div>
            );
        }

        // --- Mount the App ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <StrictMode>
                <App />
            </StrictMode>
        );

    </script>
</body>
</html>
